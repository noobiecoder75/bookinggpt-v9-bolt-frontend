<!DOCTYPE html>
<html>
<head>
    <title>Gmail OAuth Callback</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 1rem;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h2>Connecting your Gmail account...</h2>
        <p>Please wait while we complete the setup.</p>
    </div>

    <script>
        // Extract parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        const state = urlParams.get('state');

        console.log('OAuth callback received:', { code: !!code, error, state });

        // Handle OAuth response
        if (error) {
            console.error('OAuth error:', error);
            
            // Send error to parent window
            if (window.opener) {
                window.opener.postMessage({
                    type: 'GMAIL_OAUTH_ERROR',
                    error: error,
                    error_description: urlParams.get('error_description') || 'OAuth authentication failed'
                }, window.location.origin);
            }
            
            // Update UI to show error
            document.querySelector('.container').innerHTML = `
                <h2>❌ Authentication Failed</h2>
                <p>Error: ${error}</p>
                <p>You can close this window and try again.</p>
            `;
            
        } else if (code) {
            console.log('OAuth success, sending code to parent window');
            
            // Send success to parent window
            if (window.opener) {
                window.opener.postMessage({
                    type: 'GMAIL_OAUTH_SUCCESS',
                    code: code,
                    state: state
                }, window.location.origin);
            }
            
            // Update UI to show success with navigation options
            document.querySelector('.container').innerHTML = `
                <div style="text-align: center;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                        <svg style="width: 40px; height: 40px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h2 style="color: #059669; margin-bottom: 1rem;">Gmail Connected Successfully!</h2>
                    <p style="margin-bottom: 2rem; color: #6b7280;">Your Gmail account has been linked to BookingGPT. You can now send emails directly from the application.</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 1rem; max-width: 300px; margin: 0 auto;">
                        <button onclick="goToSettings()" style="
                            background: #4f46e5; 
                            color: white; 
                            border: none; 
                            padding: 12px 24px; 
                            border-radius: 8px; 
                            font-weight: 600; 
                            cursor: pointer;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#4338ca'" onmouseout="this.style.background='#4f46e5'">
                            ← Back to Settings
                        </button>
                        
                        <button onclick="closeWindow()" style="
                            background: #f3f4f6; 
                            color: #374151; 
                            border: none; 
                            padding: 12px 24px; 
                            border-radius: 8px; 
                            font-weight: 500; 
                            cursor: pointer;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                            Close Window
                        </button>
                    </div>
                    
                    <p style="font-size: 0.875rem; color: #9ca3af; margin-top: 1.5rem;">
                        This window will automatically close in <span id="countdown">10</span> seconds
                    </p>
                </div>
            `;
            
            // Add navigation functions
            window.goToSettings = function() {
                if (window.opener) {
                    window.opener.location.href = '/settings';
                }
                window.close();
            };
            
            window.closeWindow = function() {
                window.close();
            };
            
            // Countdown timer
            let countdown = 10;
            const countdownElement = document.getElementById('countdown');
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdownElement) {
                    countdownElement.textContent = countdown;
                }
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    window.close();
                }
            }, 1000);
            
        } else {
            console.error('No code or error received in OAuth callback');
            
            // Send generic error to parent window
            if (window.opener) {
                window.opener.postMessage({
                    type: 'GMAIL_OAUTH_ERROR',
                    error: 'invalid_response',
                    error_description: 'No authorization code received'
                }, window.location.origin);
            }
            
            // Update UI to show error
            document.querySelector('.container').innerHTML = `
                <h2>❌ Invalid Response</h2>
                <p>No authorization code received from Google.</p>
                <p>Please close this window and try again.</p>
            `;
        }

        // Fallback: close window after 10 seconds if still open
        setTimeout(() => {
            if (!window.closed) {
                window.close();
            }
        }, 10000);
    </script>
</body>
</html>